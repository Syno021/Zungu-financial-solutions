<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Loans</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Loans</ion-title>
    </ion-toolbar>
  </ion-header>

  <!-- Loan Information Section -->
  <div class="loan-info-container">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Our Loan Offerings</ion-card-title>
        <ion-card-subtitle>Competitive rates with 1-month term</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <p>We offer various loan products to meet your financial needs with competitive interest rates and a convenient 1-month repayment term.</p>
      </ion-card-content>
    </ion-card>

    <!-- Loan Types -->
    <ion-grid>
      <ion-row>
        <ion-col size="12" size-md="6">
          <ion-card>
            <ion-card-header>
              <ion-card-title color="primary">Personal Loans</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ion-list>
                <ion-item>
                  <ion-label>
                    <h3>Amount Range</h3>
                    <p>R5,000 - R250,000</p>
                  </ion-label>
                </ion-item>
                <ion-item>
                  <ion-label>
                    <h3>Interest Rate</h3>
                    <p>30% per annum</p>
                  </ion-label>
                </ion-item>
                <ion-item>
                  <ion-label>
                    <h3>Term</h3>
                    <p>1 month</p>
                  </ion-label>
                </ion-item>
              </ion-list>
            </ion-card-content>
          </ion-card>
        </ion-col>

        <ion-col size="12" size-md="6">
          <ion-card>
            <ion-card-header>
              <ion-card-title color="secondary">Business Loans</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ion-list>
                <ion-item>
                  <ion-label>
                    <h3>Amount Range</h3>
                    <p>R10,000 - R1,000,000</p>
                  </ion-label>
                </ion-item>
                <ion-item>
                  <ion-label>
                    <h3>Interest Rate</h3>
                    <p>30% per annum</p>
                  </ion-label>
                </ion-item>
                <ion-item>
                  <ion-label>
                    <h3>Term</h3>
                    <p>1 month</p>
                  </ion-label>
                </ion-item>
              </ion-list>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>
    </ion-grid>

    <!-- Requirements Section -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Loan Requirements</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item>
            <ion-icon name="checkmark-circle" color="success" slot="start"></ion-icon>
            <ion-label>South African citizen or permanent resident</ion-label>
          </ion-item>
          <ion-item>
            <ion-icon name="checkmark-circle" color="success" slot="start"></ion-icon>
            <ion-label>Minimum age of 18 years</ion-label>
          </ion-item>
          <ion-item>
            <ion-icon name="checkmark-circle" color="success" slot="start"></ion-icon>
            <ion-label>Proof of income (3 months payslips)</ion-label>
          </ion-item>
          <ion-item>
            <ion-icon name="checkmark-circle" color="success" slot="start"></ion-icon>
            <ion-label>Valid ID document</ion-label>
          </ion-item>
          <ion-item>
            <ion-icon name="checkmark-circle" color="success" slot="start"></ion-icon>
            <ion-label>Bank statements (3 months)</ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Apply Button -->
    <div class="apply-button-container">
      <ion-button expand="full" size="large" color="primary" (click)="openLoanApplicationModal()">
        <ion-icon name="card" slot="start"></ion-icon>
        Apply for a Loan Now
      </ion-button>
    </div>
  </div>

  <!-- Loan Application Modal -->
  <ion-modal [isOpen]="isModalOpen" (didDismiss)="closeModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Loan Application</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeModal()">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      
      <ion-content>
        <form (ngSubmit)="submitLoanApplication()" #loanForm="ngForm">
          <ion-list>
            <ion-item>
              <ion-select 
                label="Loan Type" 
                placeholder="Select loan type" 
                [(ngModel)]="loanApplication.purpose" 
                name="purpose" 
                required>
                <ion-select-option value="personal">Personal Loan</ion-select-option>
                <ion-select-option value="business">Business Loan</ion-select-option>
              </ion-select>
            </ion-item>

            <ion-item>
              <ion-input 
                label="Loan Amount (R)" 
                type="number" 
                placeholder="Enter amount" 
                [(ngModel)]="loanApplication.amount" 
                name="amount" 
                required
                min="1000">
              </ion-input>
            </ion-item>

            <!-- Hidden term field with fixed value of 1 month -->
            <input type="hidden" [(ngModel)]="loanApplication.term" name="term" value="1">
            
            <!-- Display-only field showing the fixed term -->
            <ion-item>
              <ion-label>
                <h3>Loan Term</h3>
                <p>1 month (fixed)</p>
              </ion-label>
            </ion-item>

            <ion-item>
              <ion-input 
                label="Full Name" 
                type="text" 
                placeholder="Enter your full name" 
                [(ngModel)]="loanApplication.fullName" 
                name="fullName" 
                required
                readonly>
              </ion-input>
            </ion-item>

            <ion-item>
              <ion-input 
                label="Email Address" 
                type="email" 
                placeholder="Enter your email" 
                [(ngModel)]="loanApplication.email" 
                name="email" 
                required
                readonly>
              </ion-input>
            </ion-item>

            <ion-item>
              <ion-input 
                label="Phone Number" 
                type="tel" 
                placeholder="Enter your phone number" 
                [(ngModel)]="loanApplication.phone" 
                name="phone" 
                required
                readonly>
              </ion-input>
            </ion-item>

            <ion-item>
              <ion-input 
                label="Monthly Income (R)" 
                type="number" 
                placeholder="Enter monthly income" 
                [(ngModel)]="loanApplication.monthlyIncome" 
                name="monthlyIncome" 
                required>
              </ion-input>
            </ion-item>

            <ion-item>
              <ion-textarea 
                label="Additional Information" 
                placeholder="Any additional information about your loan application" 
                [(ngModel)]="loanApplication.additionalInfo" 
                name="additionalInfo"
                rows="3">
              </ion-textarea>
            </ion-item>
          </ion-list>

          <!-- Estimated Interest Rate Display -->
          <ion-card *ngIf="estimatedRate > 0">
            <ion-card-header>
              <ion-card-title color="primary">Estimated Loan Details</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ion-item>
                <ion-label>
                  <h3>Interest Rate</h3>
                  <p>{{ estimatedRate }}% per annum</p>
                </ion-label>
              </ion-item>
              <ion-item>
                <ion-label>
                  <h3>Estimated Monthly Payment</h3>
                  <p>R{{ calculateMonthlyPayment() | number:'1.2-2' }}</p>
                </ion-label>
              </ion-item>
              <ion-item>
                <ion-label>
                  <h3>Loan Term</h3>
                  <p>1 month</p>
                </ion-label>
              </ion-item>
            </ion-card-content>
          </ion-card>

          <div class="ion-padding">
            <ion-button 
              expand="full" 
              type="submit" 
              color="primary" 
              [disabled]="!loanForm.valid || isSubmitting">
              <ion-icon name="send" slot="start"></ion-icon>
              {{ isSubmitting ? 'Submitting...' : 'Submit Application' }}
            </ion-button>
          </div>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- KYC Documents Modal -->
  <ion-modal [isOpen]="isKycModalOpen" (didDismiss)="closeKycModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>KYC Verification</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeKycModal()" fill="clear">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding">
        <div class="kyc-info">
          <ion-card>
            <ion-card-header>
              <ion-card-title>Document Verification Required</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <p>To apply for a loan, please upload the following documents for verification:</p>
              <ul>
                <li>Valid ID Document (National ID, Passport, or Driver's License)</li>
                <li>Proof of Residence (Utility bill, Bank statement, or Rental agreement)</li>
              </ul>
              <p><strong>Note:</strong> Documents must be clear and readable. Accepted formats: JPEG, PNG, PDF (max 5MB each)</p>
            </ion-card-content>
          </ion-card>
        </div>

        <form #kycForm="ngForm" (ngSubmit)="submitKycDocuments()">
          <!-- ID Document Upload -->
          <ion-card>
            <ion-card-header>
              <ion-card-title>ID Document</ion-card-title>
              <ion-card-subtitle>Upload a valid government-issued ID</ion-card-subtitle>
            </ion-card-header>
            <ion-card-content>
              <div class="file-upload-section">
                <input 
                  type="file" 
                  accept="image/*,.pdf" 
                  (change)="onFileSelected($event, 'idDocument')"
                  #idFileInput
                  style="display: none;"
                >
                
                <ion-button expand="block" fill="outline" (click)="idFileInput.click()">
                  <ion-icon name="cloud-upload" slot="start"></ion-icon>
                  {{ kycDocuments.idDocument ? 'Change ID Document' : 'Select ID Document' }}
                </ion-button>
                
                <div *ngIf="kycDocuments.idDocument" class="file-info">
                  <ion-chip color="success">
                    <ion-icon name="document"></ion-icon>
                    <ion-label>{{ kycDocuments.idDocument.name }}</ion-label>
                  </ion-chip>
                </div>
              </div>
            </ion-card-content>
          </ion-card>

          <!-- Proof of Residence Upload -->
          <ion-card>
            <ion-card-header>
              <ion-card-title>Proof of Residence</ion-card-title>
              <ion-card-subtitle>Upload a recent utility bill or bank statement</ion-card-subtitle>
            </ion-card-header>
            <ion-card-content>
              <div class="file-upload-section">
                <input 
                  type="file" 
                  accept="image/*,.pdf" 
                  (change)="onFileSelected($event, 'proofOfResidence')"
                  #residenceFileInput
                  style="display: none;"
                >
                
                <ion-button expand="block" fill="outline" (click)="residenceFileInput.click()">
                  <ion-icon name="cloud-upload" slot="start"></ion-icon>
                  {{ kycDocuments.proofOfResidence ? 'Change Proof of Residence' : 'Select Proof of Residence' }}
                </ion-button>
                
                <div *ngIf="kycDocuments.proofOfResidence" class="file-info">
                  <ion-chip color="success">
                    <ion-icon name="document"></ion-icon>
                    <ion-label>{{ kycDocuments.proofOfResidence.name }}</ion-label>
                  </ion-chip>
                </div>
              </div>
            </ion-card-content>
          </ion-card>

          <!-- Terms and Conditions -->
          <ion-card>
            <ion-card-content>
              <ion-checkbox labelPlacement="end" #termsCheckbox>
                <div class="terms-text">
                  I confirm that the documents uploaded are genuine and belong to me. I understand that providing false information may result in rejection of my application.
                </div>
              </ion-checkbox>
            </ion-card-content>
          </ion-card>

          <!-- Submit Button -->
          <div class="submit-section">
            <ion-button 
              expand="block" 
              type="submit" 
              [disabled]="!kycDocuments.idDocument || !kycDocuments.proofOfResidence || !termsCheckbox.checked || isSubmitting"
              color="primary"
            >
              <ion-icon name="cloud-upload" slot="start" *ngIf="!isSubmitting"></ion-icon>
              <ion-spinner slot="start" *ngIf="isSubmitting"></ion-spinner>
              {{ isSubmitting ? 'Uploading...' : 'Submit Documents' }}
            </ion-button>
          </div>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>