<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Room Management</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <ion-card class="filter-card">
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="filter-outline" class="filter-icon"></ion-icon>
        Filters
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <form [formGroup]="filterForm">
        <ion-grid>
          <ion-row>
            <ion-col size="12" size-md="3">
              <ion-item lines="none">
                <ion-icon name="bed-outline" slot="start"></ion-icon>
                <ion-label position="stacked">Room Type</ion-label>
                <ion-select formControlName="roomType" interface="popover">
                  <ion-select-option value="">All</ion-select-option>
                  <ion-select-option *ngFor="let type of roomTypes" [value]="type">
                    {{ type.replace('_', ' ') }}
                  </ion-select-option>
                </ion-select>
              </ion-item>
            </ion-col>
            
            <ion-col size="12" size-md="3">
              <ion-item lines="none">
                <ion-icon name="pulse-outline" slot="start"></ion-icon>
                <ion-label position="stacked">Status</ion-label>
                <ion-select formControlName="status" interface="popover">
                  <ion-select-option value="">All</ion-select-option>
                  <ion-select-option *ngFor="let status of statusOptions" [value]="status">
                    {{ status }}
                  </ion-select-option>
                </ion-select>
              </ion-item>
            </ion-col>
            
            <ion-col size="12" size-md="6">
              <ion-item lines="none">
                <ion-icon name="search-outline" slot="start"></ion-icon>
                <ion-label position="stacked">Search</ion-label>
                <ion-input formControlName="searchTerm" placeholder="Search by room number or location"></ion-input>
              </ion-item>
            </ion-col>
          </ion-row>

          <ion-row>
            <ion-col size="12" class="ion-text-end">
              <ion-button fill="outline" (click)="resetFilters()">
                <ion-icon name="refresh-outline" slot="start"></ion-icon>
                Reset Filters
              </ion-button>
            </ion-col>
          </ion-row>
        </ion-grid>
      </form>
    </ion-card-content>
  </ion-card>

  <!-- Group rooms by type -->
  <ng-container *ngFor="let type of getUniqueRoomTypes()">
    <ion-item-divider *ngIf="getRoomsByType(type).length > 0" class="room-type-divider">
      <ion-icon [name]="getRoomTypeIcon(type)" slot="start"></ion-icon>
      <ion-label>{{ type.replace('_', ' ') }}</ion-label>
    </ion-item-divider>

    <ion-grid class="room-grid">
      <ion-row>
        <ion-col size="12" size-md="6" size-lg="4" *ngFor="let room of getRoomsByType(type)">
          <ion-card class="room-card">
            <ion-card-header>
              <ion-badge [color]="getRoomStatusColor(room.status)" class="status-badge">
                {{ room.status }}
              </ion-badge>
              <ion-card-title>
                <ion-icon [name]="getRoomTypeIcon(room.roomType)" class="room-icon"></ion-icon>
                Room {{ room.roomNumber }}
              </ion-card-title>
              <ion-card-subtitle>{{ room.location }}</ion-card-subtitle>
            </ion-card-header>
            
            <ion-card-content>
              <ion-grid>
                <ion-row>
                  <!-- Occupancy Details -->
                  <ion-col size="12">
                    <h3 class="section-title">
                      <ion-icon name="people-outline"></ion-icon>
                      Occupancy
                    </h3>
                    <ng-container *ngIf="(getOccupancyDetails(room) || {totalBeds: 0, occupiedBeds: 0, totalSeats: 0, occupiedSeats: 0}) as occupancy">
                      <ion-progress-bar 
                        [value]="occupancy.totalBeds ? (occupancy.occupiedBeds/occupancy.totalBeds) : 0" 
                        [color]="getOccupancyColor(occupancy.occupiedBeds, occupancy.totalBeds)">
                      </ion-progress-bar>
                      <div class="occupancy-text">
                        <p>Beds: {{ occupancy.occupiedBeds || 0 }}/{{ occupancy.totalBeds || 0 }}</p>
                        <p>Seats: {{ occupancy.occupiedSeats || 0 }}/{{ occupancy.totalSeats || 0 }}</p>
                      </div>
                    </ng-container>
                  </ion-col>
                </ion-row>

                <ion-row>
                  <!-- Allocation Buttons -->
                  <ion-col size="6">
                    <ion-button expand="block" [disabled]="room.status === 'FULL'" 
                               (click)="allocateSpace(room, 'bed')" color="primary">
                      <ion-icon name="bed-outline" slot="start"></ion-icon>
                      Allocate Bed
                    </ion-button>
                  </ion-col>
                  <ion-col size="6">
                    <ion-button expand="block" [disabled]="room.status === 'FULL'" 
                               (click)="allocateSpace(room, 'seat')" color="primary">
                      <ion-icon name="people-outline" slot="start"></ion-icon>
                      Allocate Seat
                    </ion-button>
                  </ion-col>
                </ion-row>

                <!-- Staff Assignment -->
                <ion-row>
                  <ion-col size="12">
                    <ion-accordion-group>
                      <ion-accordion>
                        <ion-item slot="header">
                          <ion-icon name="people-circle-outline" slot="start"></ion-icon>
                          <ion-label>Assigned Staff ({{ room.assignedStaff.length }})</ion-label>
                        </ion-item>
                        
                        <ion-list slot="content">
                          <ion-item *ngFor="let staff of room.assignedStaff">
                            <ion-icon name="person-outline" slot="start"></ion-icon>
                            <ion-label>{{ staff }}</ion-label>
                          </ion-item>
                          
                          <ion-item lines="none">
                            <ion-input [(ngModel)]="room.assignedStaffInput" 
                                      placeholder="Add staff member"></ion-input>
                            <ion-button slot="end" (click)="assignStaff(room)" 
                                       [disabled]="!room.assignedStaffInput?.trim()">
                              <ion-icon name="add-outline"></ion-icon>
                              Add
                            </ion-button>
                          </ion-item>
                        </ion-list>
                      </ion-accordion>
                    </ion-accordion-group>
                  </ion-col>
                </ion-row>

                <!-- Current Allocations -->
                <!-- Current Allocations -->
                <ion-row *ngIf="room.bedAllocation?.length || room.seatAllocation?.length">
                  <ion-col size="12">
                    <ion-accordion-group>
                      <ion-accordion>
                        <ion-item slot="header">
                          <ion-icon name="time-outline" slot="start"></ion-icon>
                          <ion-label>Current Allocations</ion-label>
                        </ion-item>
                        
                        <ion-list slot="content">
                          <!-- Bed Allocations -->
                          <ng-container *ngIf="room.bedAllocation">
                            <ion-item *ngFor="let bed of room.bedAllocation">
                              <ion-icon name="bed-outline" slot="start"></ion-icon>
                              <ion-label *ngIf="bed.patientId">
                                Bed {{ bed.bedNumber }} - Patient: {{ bed.patientId }}
                                <p>Time Left: {{ bed.patientId ? calculateTimeLeft(bed) : 'N/A' }}</p>
                              </ion-label>
                              <ion-label *ngIf="!bed.patientId">
                                Bed {{ bed.bedNumber }} - Available
                              </ion-label>
                            </ion-item>
                          </ng-container>

                          <!-- Seat Allocations -->
                          <ng-container *ngIf="room.seatAllocation">
                            <ion-item *ngFor="let seat of room.seatAllocation">
                              <ion-icon name="person-outline" slot="start"></ion-icon>
                              <ion-label *ngIf="seat.patientId">
                                Seat {{ seat.seatNumber }} - Patient: {{ seat.patientId }}
                                <p>Time Left: {{ calculateTimeLeft(seat) }}</p>
                              </ion-label>
                              <ion-label *ngIf="!seat.patientId">
                                Seat {{ seat.seatNumber }} - Available
                              </ion-label>
                            </ion-item>
                          </ng-container>
                        </ion-list>
                      </ion-accordion>
                    </ion-accordion-group>
                  </ion-col>
                </ion-row>
              </ion-grid>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>
    </ion-grid>
  </ng-container>
</ion-content>