<ion-header>
  <ion-toolbar>
    <ion-title>
      {{ ehr.surname }}, {{ ehr.name }}
    </ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="toggleFullscreen()">
        <ion-icon [name]="isFullscreen ? 'contract-outline' : 'expand-outline'"></ion-icon>
      </ion-button>
      <ion-button (click)="dismissModal()">
        <ion-icon name="close-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
  
  <ion-toolbar>
    <ion-segment [(ngModel)]="activeSegment" (ionChange)="segmentChanged($event)">
      <ion-segment-button value="patient-info">
        <ion-label>Patient Info</ion-label>
      </ion-segment-button>
      <ion-segment-button value="medical-history">
        <ion-label>Medical History</ion-label>
      </ion-segment-button>
      <ion-segment-button value="prescriptions">
        <ion-label>Prescriptions</ion-label>
      </ion-segment-button>
      <ion-segment-button value="results">
        <ion-label>Test Results</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Patient Info Section -->
  <div *ngIf="activeSegment === 'patient-info'">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Personal Information</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item>
            <ion-label>Full Name:</ion-label>
            <ion-note slot="end">{{ ehr.name }} {{ ehr.surname }}</ion-note>
          </ion-item>
          <ion-item>
            <ion-label>PaientId:</ion-label>
            <ion-note slot="end">{{ ehr.patientId }} </ion-note>
          </ion-item>
          <ion-item>
            <ion-label>Date of Birth</ion-label>
            <ion-text>{{ ehr.dob | date:'mediumDate' }}</ion-text>
            <ion-text>{{ ehr.dob ? (ehr.dob | date:'mediumDate') : 'No DOB available' }}</ion-text>
          </ion-item>
          <ion-item>
            <ion-label>Gender:</ion-label>
            <ion-note slot="end">{{ ehr.gender }}</ion-note>
          </ion-item>
          <ion-item>
            <ion-label>ID Number:</ion-label>
            <ion-note slot="end">{{ ehr.saIdNumber || 'Not provided' }}</ion-note>
          </ion-item>
          <ion-item>
            <ion-label>Email:</ion-label>
            <ion-note slot="end">{{ ehr.email }}</ion-note>
          </ion-item>
          <ion-item>
            <ion-label>Contact Number:</ion-label>
            <ion-note slot="end">{{ ehr.contactNumber }}</ion-note>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <ion-card>
      <ion-card-header>
        <ion-card-title>Address</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item>
            <ion-label>Street:</ion-label>
            <ion-note slot="end">{{ ehr.address.street }}</ion-note>
          </ion-item>
          <ion-item>
            <ion-label>City:</ion-label>
            <ion-note slot="end">{{ ehr.address.city }}</ion-note>
          </ion-item>
          <ion-item>
            <ion-label>Province:</ion-label>
            <ion-note slot="end">{{ ehr.address.province }}</ion-note>
          </ion-item>
          <ion-item>
            <ion-label>Postal Code:</ion-label>
            <ion-note slot="end">{{ ehr.address.postalCode }}</ion-note>
          </ion-item>
          <ion-item>
            <ion-label>Country:</ion-label>
            <ion-note slot="end">{{ ehr.address.country }}</ion-note>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <ion-card>
      <ion-card-header>
        <ion-card-title>Next of Kin</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item>
            <ion-label>Name:</ion-label>
            <ion-note slot="end">{{ ehr.nextOfKin.name }}</ion-note>
          </ion-item>
          <ion-item>
            <ion-label>Relationship:</ion-label>
            <ion-note slot="end">{{ ehr.nextOfKin.relationship }}</ion-note>
          </ion-item>
          <ion-item>
            <ion-label>Contact Number:</ion-label>
            <ion-note slot="end">{{ ehr.nextOfKin.contactNumber }}</ion-note>
          </ion-item>
          <ion-item>
            <ion-label>Address:</ion-label>
            <ion-note slot="end">
              {{ ehr.nextOfKin.address.street }}, {{ ehr.nextOfKin.address.city }}, {{ ehr.nextOfKin.address.province }}
            </ion-note>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Medical History Section -->
  <div *ngIf="activeSegment === 'medical-history'">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Conditions</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list *ngIf="ehr.medicalHistory.conditions.length > 0; else noConditions">
          <ion-item *ngFor="let condition of ehr.medicalHistory.conditions">
            <ion-label>
              <h2>{{ condition.name }}</h2>
              <p>ICD-10: {{ condition.icd10Code }} | SNOMED: {{ condition.snomedCode }}</p>
              <p>Diagnosed: {{ condition.diagnosedDate | date }}</p>
              <p>Status: {{ condition.status }}</p>
              <p>Notes: {{ condition.notes }}</p>
            </ion-label>
          </ion-item>
        </ion-list>
        <ng-template #noConditions>
          <p class="ion-text-center">No medical conditions recorded</p>
        </ng-template>
      </ion-card-content>
    </ion-card>

    <ion-card>
      <ion-card-header>
        <ion-card-title>Surgeries</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list *ngIf="ehr.medicalHistory.surgeries.length > 0; else noSurgeries">
          <ion-item *ngFor="let surgery of ehr.medicalHistory.surgeries">
            <ion-label>
              <h2>{{ surgery.procedureName }}</h2>
              <p>CPT Code: {{ surgery.cptCode }}</p>
              <p>Date: {{ surgery.performedDate | date }}</p>
              <p>Surgeon: {{ surgery.surgeon }}</p>
              <p>Facility: {{ surgery.facility }}</p>
              <p>Notes: {{ surgery.notes }}</p>
              <p *ngIf="surgery.complications">Complications: {{ surgery.complications }}</p>
            </ion-label>
          </ion-item>
        </ion-list>
        <ng-template #noSurgeries>
          <p class="ion-text-center">No surgeries recorded</p>
        </ng-template>
      </ion-card-content>
    </ion-card>

    <ion-card>
      <ion-card-header>
        <ion-card-title>Allergies</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list *ngIf="ehr.medicalHistory.allergies.length > 0; else noAllergies">
          <ion-item *ngFor="let allergy of ehr.medicalHistory.allergies">
            <ion-label>
              <h2>{{ allergy.allergen }}</h2>
              <p>SNOMED: {{ allergy.snomedCode }}</p>
              <p>Reaction: {{ allergy.reactionType }}</p>
              <p>Severity: {{ allergy.severity }}</p>
              <p>Diagnosed: {{ allergy.diagnosedDate | date }}</p>
              <p>Notes: {{ allergy.notes }}</p>
            </ion-label>
          </ion-item>
        </ion-list>
        <ng-template #noAllergies>
          <p class="ion-text-center">No allergies recorded</p>
        </ng-template>
      </ion-card-content>
    </ion-card>

    
    <ion-card>
      <ion-card-header>
        <ion-card-title>Immunizations</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list *ngIf="ehr.medicalHistory.immunizations.length > 0; else noImmunizations">
          <ion-item *ngFor="let immunization of ehr.medicalHistory.immunizations">
            <ion-label>
              <h2>{{ immunization.vaccineName }}</h2>
              <p>CPT Code: {{ immunization.cptCode }}</p>
              <p>Date: {{ immunization.administeredDate | date }}</p>
              <p>Administered by: {{ immunization.administeredBy }}</p>
              <p>Site: {{ immunization.site }}</p>
              <p>Lot #: {{ immunization.lotNumber }}</p>
              <p>Expiration: {{ immunization.expirationDate | date }}</p>
              <p>Notes: {{ immunization.notes }}</p>
            </ion-label>
          </ion-item>
        </ion-list>
        <ng-template #noImmunizations>
          <p class="ion-text-center">No immunizations recorded</p>
        </ng-template>
      </ion-card-content>
    </ion-card>

    <ion-card>
      <ion-card-header>
        <ion-card-title>Family History</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list *ngIf="ehr.medicalHistory.familyHistory.length > 0; else noFamilyHistory">
          <ion-item *ngFor="let item of ehr.medicalHistory.familyHistory">
            <ion-label>
              <h2>{{ item.condition }}</h2>
              <p>ICD-10: {{ item.icd10Code }}</p>
              <p>Relationship: {{ item.relationship }}</p>
              <p>Notes: {{ item.notes }}</p>
            </ion-label>
          </ion-item>
        </ion-list>
        <ng-template #noFamilyHistory>
          <p class="ion-text-center">No family history recorded</p>
        </ng-template>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Prescriptions Section -->
  <div *ngIf="activeSegment === 'prescriptions'">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Prescriptions</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <!-- Loading indicator -->
        <div *ngIf="loadingPrescriptions" class="ion-text-center">
          <ion-spinner></ion-spinner>
          <p>Loading prescriptions...</p>
        </div>
        
        <!-- Prescriptions list -->
        <ion-list *ngIf="!loadingPrescriptions && prescriptions.length > 0; else noPrescriptions">
          <ion-item *ngFor="let prescription of prescriptions">
            <ion-label>
              <h2>{{ prescription.medication || 'Unnamed medication' }}</h2>
              <p>Dosage: {{ prescription.dosage || 'N/A' }}</p>
              <p>Duration: {{ prescription.duration || 'N/A' }}</p>
              <p>Issued Date: {{ prescription.issuedAt | date }}</p>
              <p>Doctor ID: {{ prescription.doctorId || 'N/A' }}</p>
              <p>Prescription ID: {{ prescription.prescriptionId }}</p>
            </ion-label>
          </ion-item>
        </ion-list>
        
        <ng-template #noPrescriptions>
          <p class="ion-text-center" *ngIf="!loadingPrescriptions">No prescriptions recorded</p>
        </ng-template>
      </ion-card-content>
    </ion-card>
  </div>

 <!-- Test Results Section -->
<div *ngIf="activeSegment === 'results'">
  <!-- Laboratory Results -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>Laboratory Results</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <!-- Loading indicator -->
      <div *ngIf="loadingLabResults" class="ion-text-center">
        <ion-spinner></ion-spinner>
        <p>Loading laboratory results...</p>
      </div>
      
      <!-- Lab results list -->
      <ion-list *ngIf="!loadingLabResults && labResults.length > 0; else noLabResults">
        <ion-item *ngFor="let labResult of labResults">
          <ion-label>
            <h2>{{ labResult.testName || 'Unknown Test' }}</h2>
            <p>Result: {{ labResult.result || 'N/A' }}</p>
            <p>LOINC Code: {{ labResult.loincCode || 'N/A' }}</p>
            <p>Ordered By: {{ labResult.orderedBy || 'N/A' }}</p>
            <p>Issued Date: {{ labResult.issuedAt | date }}</p>
            <p *ngIf="labResult.emailSent">Email Status: {{ labResult.emailSent ? 'Sent' : 'Not Sent' }}</p>
            <p>Lab Order ID: {{ labResult.laborderId }}</p>
          </ion-label>
        </ion-item>
      </ion-list>
      
      <ng-template #noLabResults>
        <p class="ion-text-center" *ngIf="!loadingLabResults">No laboratory results recorded</p>
      </ng-template>
    </ion-card-content>
  </ion-card>

  <!-- Radiology Results -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>Radiology Results</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <!-- Loading indicator -->
      <div *ngIf="loadingRadiologyResults" class="ion-text-center">
        <ion-spinner></ion-spinner>
        <p>Loading radiology results...</p>
      </div>
      
      <!-- Radiology results list -->
      <ion-list *ngIf="!loadingRadiologyResults && radiologyResults.length > 0; else noRadiologyResults">
        <ion-item *ngFor="let radiologyResult of radiologyResults">
          <ion-label>
            <h2>{{ radiologyResult.scanType || 'Unknown Scan' }}</h2>
            <p>Findings: {{ radiologyResult.findings || 'N/A' }}</p>
            <p>Ordered By: {{ radiologyResult.orderedBy || 'N/A' }}</p>
            <p>Issued Date: {{ radiologyResult.issuedAt | date }}</p>
            <p *ngIf="radiologyResult.emailSent">Email Status: {{ radiologyResult.emailSent ? 'Sent' : 'Not Sent' }}</p>
            <p>Radiology ID: {{ radiologyResult.radiologyId }}</p>
          </ion-label>
        </ion-item>
      </ion-list>
      
      <ng-template #noRadiologyResults>
        <p class="ion-text-center" *ngIf="!loadingRadiologyResults">No radiology results recorded</p>
      </ng-template>
    </ion-card-content>
  </ion-card>

  <!-- Diagnosis Codes section remains the same -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>Diagnosis Codes</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-list>
        <ion-item *ngIf="ehr.icd10DiagnosisCodes && ehr.icd10DiagnosisCodes.length > 0; else noIcd10">
          <ion-label>
            <h2>ICD-10 Codes</h2>
            <p *ngFor="let code of ehr.icd10DiagnosisCodes">{{ code }}</p>
          </ion-label>
        </ion-item>
        <ng-template #noIcd10>
          <ion-item>
            <ion-label class="ion-text-center">No ICD-10 codes recorded</ion-label>
          </ion-item>
        </ng-template>
        
        <ion-item *ngIf="ehr.snomedCodes && ehr.snomedCodes.length > 0; else noSnomed">
          <ion-label>
            <h2>SNOMED Codes</h2>
            <p *ngFor="let code of ehr.snomedCodes">{{ code }}</p>
          </ion-label>
        </ion-item>
        <ng-template #noSnomed>
          <ion-item>
            <ion-label class="ion-text-center">No SNOMED codes recorded</ion-label>
          </ion-item>
        </ng-template>
      </ion-list>
    </ion-card-content>
  </ion-card>
</div>
</ion-content>

<ion-footer>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button color="success" (click)="generatePDF()">
        <ion-icon name="print-outline" slot="start"></ion-icon>
       Download Medical Record
      </ion-button>
    </ion-buttons>
    <ion-buttons slot="end">
      <ion-button color="success" (click)="authenticateAsPatient()">
        <ion-icon name="person-add-outline" slot="start"></ion-icon>
        Create Patient Account
      </ion-button>
     
    </ion-buttons>
  </ion-toolbar>
</ion-footer>