<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/dashboard"></ion-back-button>
    </ion-buttons>
    <ion-title>Add New EHR Record</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <form [formGroup]="ehrForm" (ngSubmit)="onSubmit()">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Patient Information</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-item>
          <ion-label position="floating">First Name <ion-text color="danger">*</ion-text></ion-label>
          <ion-input formControlName="name" type="text" required></ion-input>
        </ion-item>
        
        <ion-item>
          <ion-label position="floating">Surname <ion-text color="danger">*</ion-text></ion-label>
          <ion-input formControlName="surname" type="text" required></ion-input>
        </ion-item>
        
        <ion-item>
          <ion-label position="floating">Email</ion-label>
          <ion-input formControlName="email" type="email"></ion-input>
        </ion-item>
        
        <ion-item>
          <ion-label position="floating">SA ID Number</ion-label>
          <ion-input formControlName="saIdNumber"></ion-input>
        </ion-item>
        <ion-text color="danger" *ngIf="ehrForm.get('saIdNumber')?.hasError('invalidIdNumber') && ehrForm.get('saIdNumber')?.touched">
          Invalid South African ID number.
        </ion-text>
        
        <ion-item>
          <ion-label position="floating">Date of Birth <ion-text color="danger">*</ion-text></ion-label>
          <ion-input formControlName="dob" type="date" required></ion-input>
        </ion-item>
        
        <ion-item>
          <ion-label>Gender <ion-text color="danger">*</ion-text></ion-label>
          <ion-select formControlName="gender" placeholder="Select gender" required>
            <ion-select-option value="Male">Male</ion-select-option>
            <ion-select-option value="Female">Female</ion-select-option>
            <ion-select-option value="Other">Other</ion-select-option>
          </ion-select>
        </ion-item>
        
        <ion-item>
          <ion-label position="floating">Contact Number</ion-label>
          <ion-input formControlName="contactNumber" type="tel"></ion-input>
        </ion-item>
      </ion-card-content>
    </ion-card>
    
    <ion-card>
      <ion-card-header>
        <ion-card-title>Address</ion-card-title>
        <ion-card-subtitle>Optional</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <ion-item>
          <ion-label position="floating">Street</ion-label>
          <ion-input formControlName="street" type="text"></ion-input>
        </ion-item>
        
        <ion-item>
          <ion-label position="floating">City</ion-label>
          <ion-input formControlName="city" type="text"></ion-input>
        </ion-item>
        
        <ion-item>
          <ion-label position="floating">Province</ion-label>
          <ion-input formControlName="province" type="text"></ion-input>
        </ion-item>
        
        <ion-item>
          <ion-label position="floating">Postal Code</ion-label>
          <ion-input formControlName="postalCode" type="text"></ion-input>
        </ion-item>
        
        <ion-item>
          <ion-label position="floating">Country</ion-label>
          <ion-input formControlName="country" type="text"></ion-input>
        </ion-item>
      </ion-card-content>
    </ion-card>
    
    <ion-card>
      <ion-card-header>
        <ion-card-title>Next of Kin</ion-card-title>
        <ion-card-subtitle>Optional</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <ion-item>
          <ion-label position="floating">Name</ion-label>
          <ion-input formControlName="kinName" type="text"></ion-input>
        </ion-item>
        
        <ion-item>
          <ion-label position="floating">Relationship</ion-label>
          <ion-input formControlName="kinRelationship" type="text"></ion-input>
        </ion-item>
        
        <ion-item>
          <ion-label position="floating">Contact Number</ion-label>
          <ion-input formControlName="kinContactNumber" type="tel"></ion-input>
        </ion-item>
      </ion-card-content>
    </ion-card>
    
    <ion-card>
      <ion-card-header>
        <ion-card-title>Medical Coding</ion-card-title>
        <ion-card-subtitle>Optional - Enter comma-separated values</ion-card-subtitle>
      </ion-card-header>

      <ion-card>
        <ion-card-header lines="none">
          <ion-card-title style="display: flex; justify-content: space-between; align-items: center;">
            <ion-label class="ion-padding-start">ICD 10 CODES</ion-label>
            <ion-button (click)="openICD10Modal()">
              <ion-icon name="add-outline"></ion-icon>
              Add</ion-button>
          </ion-card-title>
        </ion-card-header>
        
        
        <ion-card-content  *ngIf="selectedICDCodes.length > 0">
          <ion-card *ngFor="let code of selectedICDCodes" class="code-card">
            <ion-card-content>
              <ion-grid>
                <ion-row class="ion-align-items-center">
                  <ion-col size="1" class="code-icon">
                    <ion-icon name="medical-outline" color="primary"></ion-icon>
                  </ion-col>
                  <ion-col size="9">
                    <div class="code-info">
                      <div class="code-header">
                        <ion-text color="primary" class="code-value">
                          <ion-icon name="code-working-outline"></ion-icon>
                          {{code.code}}
                        </ion-text>
                        <ion-chip [color]="getCategoryColor(code.category)" class="category-chip">
                          <ion-icon [name]="getCategoryIcon(code.category)"></ion-icon>
                          <ion-label>{{code.category}}</ion-label>
                        </ion-chip>
                      </div>
                      <p class="description">
                        <ion-icon name="information-circle-outline"></ion-icon>
                        {{code.shortDescription}}
                      </p>
                      <p class="subcategory" *ngIf="code.subCategory">
                        <ion-icon name="git-branch-outline"></ion-icon>
                        {{code.subCategory}}
                      </p>
                    </div>
                  </ion-col>
                  <ion-col size="2" class="ion-text-end">
                    <ion-button fill ="clear" color="danger" (click)="removeCode(code)" class="remove-btn">
                      <ion-icon name="close-outline" slot="icon-only"></ion-icon>
                    </ion-button>
                  </ion-col>
                </ion-row>
              </ion-grid>
            </ion-card-content>
          </ion-card>
        </ion-card-content>
        </ion-card>
        
      <ion-card-content>
        <ion-item>
          <ion-label position="floating">ICD-10 Diagnosis Codes</ion-label>
          <ion-textarea formControlName="icd10Codes" rows="2"></ion-textarea>
        </ion-item>
        
        <ion-item>
          <ion-label position="floating">SNOMED Codes</ion-label>
          <ion-textarea formControlName="snomedCodes" rows="2"></ion-textarea>
        </ion-item>
      </ion-card-content>
    </ion-card>
    
    <!-- Optional Forms Button Section -->
    <div class="ion-padding">
      <ion-button expand="block" (click)="toggleMedicalHistory()" color="secondary">
        {{ showMedicalHistory ? 'Hide Medical History' : 'Add Medical History' }}
      </ion-button>
      
      <ion-button expand="block" (click)="togglePrescription()" color="tertiary" class="ion-margin-top">
        {{ showPrescription ? 'Hide Prescription' : 'Add Prescription' }}
      </ion-button>
    </div>
    
    <!-- Medical History Form Section -->
    <ion-card *ngIf="showMedicalHistory" [formGroup]="medicalHistoryForm">
      <ion-card-header>
        <ion-card-title>Medical History</ion-card-title>
      </ion-card-header>
      
      <!-- Medical Conditions Section -->
      <ion-card-content>
        <ion-item-divider color="light">
          <ion-label>Medical Conditions</ion-label>
          <ion-button fill="clear" slot="end" (click)="addCondition()">
            <ion-icon name="add"></ion-icon>
          </ion-button>
        </ion-item-divider>
        
        <div formArrayName="conditions">
          <div *ngFor="let condition of conditions.controls; let i = index" [formGroupName]="i" class="form-array-item">
            <ion-item>
              <ion-label position="floating">Condition Name</ion-label>
              <ion-input formControlName="name" type="text" required></ion-input>
            </ion-item>
            
            <ion-item>
              <ion-label position="floating">ICD-10 Code</ion-label>
              <ion-input formControlName="icd10Code" type="text"></ion-input>
            </ion-item>
            
            <ion-item>
              <ion-label position="floating">SNOMED Code</ion-label>
              <ion-input formControlName="snomedCode" type="text"></ion-input>
            </ion-item>
            
            <ion-item>
              <ion-label position="floating">Diagnosed Date</ion-label>
              <ion-input formControlName="diagnosedDate" type="date"></ion-input>
            </ion-item>
            
            <ion-item>
              <ion-label>Status</ion-label>
              <ion-select formControlName="status" placeholder="Select status">
                <ion-select-option *ngFor="let option of statusOptions" [value]="option">{{ option }}</ion-select-option>
              </ion-select>
            </ion-item>
            
            <ion-item>
              <ion-label position="floating">Notes</ion-label>
              <ion-textarea formControlName="notes" rows="2"></ion-textarea>
            </ion-item>
            
            <ion-item>
              <ion-label position="floating">Treating Physician</ion-label>
              <ion-input formControlName="treatingPhysician" type="text"></ion-input>
            </ion-item>
            
            <ion-button fill="outline" color="danger" (click)="removeCondition(i)">
              <ion-icon name="trash"></ion-icon>
              Remove
            </ion-button>
            <hr>
          </div>
        </div>
        
        <!-- Surgeries Section -->
        <ion-item-divider color="light">
          <ion-label>Surgeries</ion-label>
          <ion-button fill="clear" slot="end" (click)="addSurgery()">
            <ion-icon name="add"></ion-icon>
          </ion-button>
        </ion-item-divider>
        
        <div formArrayName="surgeries">
          <div *ngFor="let surgery of surgeries.controls; let i = index" [formGroupName]="i" class="form-array-item">
            <ion-item>
              <ion-label position="floating">Procedure Name</ion-label>
              <ion-input formControlName="procedureName" type="text" required></ion-input>
            </ion-item>
            
            <ion-item>
              <ion-label position="floating">CPT Code</ion-label>
              <ion-input formControlName="cptCode" type="text"></ion-input>
            </ion-item>
            
            <ion-item>
              <ion-label position="floating">Performed Date</ion-label>
              <ion-input formControlName="performedDate" type="date"></ion-input>
            </ion-item>
            
            <ion-item>
              <ion-label position="floating">Surgeon</ion-label>
              <ion-input formControlName="surgeon" type="text"></ion-input>
            </ion-item>
            
            <ion-item>
              <ion-label position="floating">Facility</ion-label>
              <ion-input formControlName="facility" type="text"></ion-input>
            </ion-item>
            
            <ion-item>
              <ion-label position="floating">Complications</ion-label>
              <ion-textarea formControlName="complications" rows="2"></ion-textarea>
            </ion-item>
            
            <ion-item>
              <ion-label position="floating">Notes</ion-label>
              <ion-textarea formControlName="notes" rows="2"></ion-textarea>
            </ion-item>
            
            <ion-button fill="outline" color="danger" (click)="removeSurgery(i)">
              <ion-icon name="trash"></ion-icon>
              Remove
            </ion-button>
            <hr>
          </div>
        </div>
        
        <!-- Allergies Section -->
        <ion-item-divider color="light">
          <ion-label>Allergies</ion-label>
          <ion-button fill="clear" slot="end" (click)="addAllergy()">
            <ion-icon name="add"></ion-icon>
          </ion-button>
        </ion-item-divider>
        
        <div formArrayName="allergies">
          <div *ngFor="let allergy of allergies.controls; let i = index" [formGroupName]="i" class="form-array-item">
            <ion-item>
              <ion-label position="floating">Allergen</ion-label>
              <ion-input formControlName="allergen" type="text" required></ion-input>
            </ion-item>
            
            <ion-item>
              <ion-label position="floating">SNOMED Code</ion-label>
              <ion-input formControlName="snomedCode" type="text"></ion-input>
            </ion-item>
            
            <ion-item>
              <ion-label position="floating">Reaction Type</ion-label>
              <ion-input formControlName="reactionType" type="text"></ion-input>
            </ion-item>
            
            <ion-item>
              <ion-label>Severity</ion-label>
              <ion-select formControlName="severity" placeholder="Select severity">
                <ion-select-option *ngFor="let option of severityOptions" [value]="option">{{ option }}</ion-select-option>
              </ion-select>
            </ion-item>
            
            <ion-item>
              <ion-label position="floating">Diagnosed Date</ion-label>
              <ion-input formControlName="diagnosedDate" type="date"></ion-input>
            </ion-item>
            
            <ion-item>
              <ion-label position="floating">Notes</ion-label>
              <ion-textarea formControlName="notes" rows="2"></ion-textarea>
            </ion-item>
            
            <ion-button fill="outline" color="danger" (click)="removeAllergy(i)">
              <ion-icon name="trash"></ion-icon>
              Remove
            </ion-button>
            <hr>
          </div>
        </div>
        
        <!-- Immunizations Section -->
        <ion-item-divider color="light">
          <ion-label>Immunizations</ion-label>
          <ion-button fill="clear" slot="end" (click)="addImmunization()">
            <ion-icon name="add"></ion-icon>
          </ion-button>
        </ion-item-divider>
        
        <div formArrayName="immunizations">
          <div *ngFor="let immunization of immunizations.controls; let i = index" [formGroupName]="i" class="form-array-item">
            <ion-item>
              <ion-label position="floating">Vaccine Name</ion-label>
              <ion-input formControlName="vaccineName" type="text" required></ion-input>
            </ion-item>
            
            <ion-item>
              <ion-label position="floating">CPT Code</ion-label>
              <ion-input formControlName="cptCode" type="text"></ion-input>
            </ion-item>
            
            <ion-item>
              <ion-label position="floating">Administered Date</ion-label>
              <ion-input formControlName="administeredDate" type="date"></ion-input>
            </ion-item>
            
            <ion-item>
              <ion-label position="floating">Administered By</ion-label>
              <ion-input formControlName="administeredBy" type="text"></ion-input>
            </ion-item>
            
            <ion-item>
              <ion-label position="floating">Lot Number</ion-label>
              <ion-input formControlName="lotNumber" type="text"></ion-input>
            </ion-item>
            
            <ion-item>
              <ion-label position="floating">Expiration Date</ion-label>
              <ion-input formControlName="expirationDate" type="date"></ion-input>
            </ion-item>
            
            <ion-item>
              <ion-label>Administration Site</ion-label>
              <ion-select formControlName="site" placeholder="Select site">
                <ion-select-option *ngFor="let option of siteOptions" [value]="option">{{ option }}</ion-select-option>
              </ion-select>
            </ion-item>
            
            <ion-item>
              <ion-label position="floating">Notes</ion-label>
              <ion-textarea formControlName="notes" rows="2"></ion-textarea>
            </ion-item>
            
            <ion-button fill="outline" color="danger" (click)="removeImmunization(i)">
              <ion-icon name="trash"></ion-icon>
              Remove
            </ion-button>
            <hr>
          </div>
        </div>
        
        <!-- Family History Section -->
        <ion-item-divider color="light">
          <ion-label>Family History</ion-label>
          <ion-button fill="clear" slot="end" (click)="addFamilyHistoryItem()">
            <ion-icon name="add"></ion-icon>
          </ion-button>
        </ion-item-divider>
        
        <div formArrayName="familyHistory">
          <div *ngFor="let item of familyHistory.controls; let i = index" [formGroupName]="i" class="form-array-item">
            <ion-item>
              <ion-label position="floating">Condition</ion-label>
              <ion-input formControlName="condition" type="text" required></ion-input>
            </ion-item>
            
            <ion-item>
              <ion-label position="floating">ICD-10 Code</ion-label>
              <ion-input formControlName="icd10Code" type="text"></ion-input>
            </ion-item>
            
            <ion-item>
              <ion-label>Relationship</ion-label>
              <ion-select formControlName="relationship" placeholder="Select relationship">
                <ion-select-option *ngFor="let option of relationshipOptions" [value]="option">{{ option }}</ion-select-option>
              </ion-select>
            </ion-item>
            
            <ion-item>
              <ion-label position="floating">Notes</ion-label>
              <ion-textarea formControlName="notes" rows="2"></ion-textarea>
            </ion-item>
            
            <ion-button fill="outline" color="danger" (click)="removeFamilyHistoryItem(i)">
              <ion-icon name="trash"></ion-icon>
              Remove
            </ion-button>
            <hr>
          </div>
        </div>
      </ion-card-content>
    </ion-card>
    
 <!-- Prescription Form Section -->
<ion-card *ngIf="showPrescription" [formGroup]="prescriptionForm">
  <ion-card-header>
    <ion-card-title>Prescription</ion-card-title>
  </ion-card-header>
  <ion-card-content>
    <ion-item>
      <ion-label position="floating">Medication <ion-text color="danger">*</ion-text></ion-label>
      <ion-input formControlName="medication" type="text" required></ion-input>
    </ion-item>
    
    <ion-item>
      <ion-label position="floating">Dosage <ion-text color="danger">*</ion-text></ion-label>
      <ion-input formControlName="dosage" type="text" required></ion-input>
    </ion-item>
    
    <ion-item>
      <ion-label position="floating">Duration <ion-text color="danger">*</ion-text></ion-label>
      <ion-input formControlName="duration" type="text" required></ion-input>
    </ion-item>
  </ion-card-content>
</ion-card>

<!-- Submit Button -->
<div class="ion-padding">
  <ion-button expand="block" type="submit" [disabled]="loading">
    <ion-spinner name="dots" *ngIf="loading"></ion-spinner>
    <span *ngIf="!loading">Create EHR Record</span>
  </ion-button>
</div>
</form>
</ion-content>