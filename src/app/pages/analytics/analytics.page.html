<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/dashboard"></ion-back-button>
    </ion-buttons>
    <ion-title>Facility Analytics</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-grid>
    <ion-row>
      <ion-col size="12">
        <ion-card>
          <ion-card-header>
            <ion-card-title>{{ facilityName || 'Facility' }} Analytics Dashboard</ion-card-title>
            <ion-card-subtitle>
              <ion-segment [(ngModel)]="selectedTimeframe" (ionChange)="changeTimeframe(selectedTimeframe)">
                <ion-segment-button value="daily">
                  <ion-label>Daily</ion-label>
                </ion-segment-button>
                <ion-segment-button value="weekly">
                  <ion-label>Weekly</ion-label>
                </ion-segment-button>
                <ion-segment-button value="monthly">
                  <ion-label>Monthly</ion-label>
                </ion-segment-button>
                <ion-segment-button value="yearly">
                  <ion-label>Yearly</ion-label>
                </ion-segment-button>
              </ion-segment>
            </ion-card-subtitle>
          </ion-card-header>
          <ion-card-content>
            <!-- Rest of the content remains the same -->
            <div *ngIf="isLoading">
              <ion-spinner name="circular"></ion-spinner>
              <p>Loading data...</p>
            </div>
            
            <div *ngIf="!isLoading && error">
              <ion-text color="danger">
                <p>{{ error }}</p>
              </ion-text>
            </div>
            
            <div *ngIf="!isLoading && !error && summaryData">
              <ion-grid>
                <ion-row>
                  <ion-col size="12" size-md="6">
                    <h3>Facility Activity Summary</h3>
                    <canvas #activityCanvas></canvas>
                  </ion-col>
                  <ion-col size="12" size-md="6">
                    <h3>Key Statistics</h3>
                    <ion-list>
                      <ion-item>
                        <ion-label>Total Patients</ion-label>
                        <ion-note slot="end">{{ summaryData?.totalPatients || 0 }}</ion-note>
                      </ion-item>
                      <ion-item>
                        <ion-label>Total Prescriptions</ion-label>
                        <ion-note slot="end">{{ summaryData?.totalPrescriptions || 0 }}</ion-note>
                      </ion-item>
                      <ion-item>
                        <ion-label>Total Lab Results</ion-label>
                        <ion-note slot="end">{{ summaryData?.totalLabResults || 0 }}</ion-note>
                      </ion-item>
                      <ion-item>
                        <ion-label>Total Radiology Results</ion-label>
                        <ion-note slot="end">{{ summaryData?.totalRadiologyResults || 0 }}</ion-note>
                      </ion-item>
                      <ion-item>
                        <ion-label>Room Utilization</ion-label>
                        <ion-note slot="end">{{ summaryData?.roomUtilization?.activeRooms || 0 }} active / {{ summaryData?.roomUtilization?.totalAllocations || 0 }} total</ion-note>
                      </ion-item>
                    </ion-list>
                  </ion-col>
                </ion-row>
              </ion-grid>
            </div>
          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>

    <!-- Staff Analytics Section -->
    <ion-row *ngIf="!selectedStaff">
      <ion-col size="12">
        <ion-card>
          <ion-card-header>
            <ion-card-title>Staff Performance</ion-card-title>
            <ion-card-subtitle>Click on a staff member to view detailed audit trail</ion-card-subtitle>
          </ion-card-header>
          <ion-card-content>
            <div *ngIf="!isLoading && staffMetrics.length > 0">
              <h3>Staff Comparison</h3>
              <canvas #staffComparisonCanvas></canvas>
              
              <h3>Staff Activity List</h3>
              <ion-list>
                <ion-item *ngFor="let staff of staffMetrics" button (click)="viewStaffDetails(staff)">
                  <ion-avatar slot="start">
                    <ion-icon name="person-circle" size="large"></ion-icon>
                  </ion-avatar>
                  <ion-label>
                    <h2>{{ staff.name }}</h2>
                    <p>{{ staff.role }}</p>
                  </ion-label>
                  <ion-note slot="end">
                    Last active: {{ getFormattedDate(staff.lastActivity) }}
                  </ion-note>
                </ion-item>
              </ion-list>
            </div>
            <div *ngIf="!isLoading && staffMetrics.length === 0">
              <ion-text color="medium">
                <p>No staff activity data available for the selected timeframe.</p>
              </ion-text>
            </div>
          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>

    <!-- Staff Detail View -->
    <ion-row *ngIf="selectedStaff">
      <ion-col size="12">
        <ion-card>
          <ion-card-header>
            <ion-buttons slot="start">
              <ion-button (click)="closeStaffDetails()">
                <ion-icon name="arrow-back"></ion-icon>
                Back to Staff List
              </ion-button>
            </ion-buttons>
            <ion-card-title>{{ selectedStaff.name }} - {{ selectedStaff.role }}</ion-card-title>
            <ion-card-subtitle>Staff ID: {{ selectedStaff.staffId }}</ion-card-subtitle>
          </ion-card-header>
          <ion-card-content>
            <ion-grid>
              <ion-row>
                <ion-col size="12" size-md="6">
                  <h3>Performance Summary</h3>
                  <ion-list>
                    <ion-item>
                      <ion-label>Assigned Patients</ion-label>
                      <ion-note slot="end">{{ selectedStaff.totalPatientsAssigned }}</ion-note>
                    </ion-item>
                    <ion-item>
                      <ion-label>Prescriptions Issued</ion-label>
                      <ion-note slot="end">{{ selectedStaff.totalPrescriptionsIssued }}</ion-note>
                    </ion-item>
                    <ion-item>
                      <ion-label>Lab Orders Processed</ion-label>
                      <ion-note slot="end">{{ selectedStaff.totalLabOrdersProcessed }}</ion-note>
                    </ion-item>
                    <ion-item>
                      <ion-label>Radiology Orders Processed</ion-label>
                      <ion-note slot="end">{{ selectedStaff.totalRadiologyOrdersProcessed }}</ion-note>
                    </ion-item>
                    <ion-item>
                      <ion-label>EHR Updates</ion-label>
                      <ion-note slot="end">{{ selectedStaff.totalEhrUpdates }}</ion-note>
                    </ion-item>
                    <ion-item>
                      <ion-label>Inventory Movements</ion-label>
                      <ion-note slot="end">{{ selectedStaff.totalInventoryMovements }}</ion-note>
                    </ion-item>
                    <ion-item>
                      <ion-label>Last Activity</ion-label>
                      <ion-note slot="end">{{ getFormattedDate(selectedStaff.lastActivity) }}</ion-note>
                    </ion-item>
                  </ion-list>
                </ion-col>
                <ion-col size="12" size-md="6" *ngIf="staffAuditLogs.length > 0">
                  <h3>Activity Breakdown</h3>
                  <canvas #auditTrailCanvas></canvas>
                </ion-col>
              </ion-row>
            </ion-grid>

            <div>
              <h3>Audit Trail</h3>
              <ion-segment (ionChange)="handleFilterChange($event)">
                <ion-segment-button value="null">
                  <ion-label>All</ion-label>
                </ion-segment-button>
                <ion-segment-button value="patient">
                  <ion-label>Patients</ion-label>
                </ion-segment-button>
                <ion-segment-button value="ehr">
                  <ion-label>EHR</ion-label>
                </ion-segment-button>
                <ion-segment-button value="prescription">
                  <ion-label>Rx</ion-label>
                </ion-segment-button>
                <ion-segment-button value="labResult">
                  <ion-label>Lab</ion-label>
                </ion-segment-button>
                <ion-segment-button value="radiologyResult">
                  <ion-label>Rad</ion-label>
                </ion-segment-button>
                <ion-segment-button value="inventory">
                  <ion-label>Inventory</ion-label>
                </ion-segment-button>
              </ion-segment>
              
              <ion-list>
                <ion-item *ngFor="let log of staffAuditLogs">
                  <ion-label>
                    <h3>{{ log.action }}</h3>
                    <p>{{ getEntityTypeLabel(log.entityType) }} ID: {{ log.entityId }}</p>
                    <p>{{ log.details }}</p>
                  </ion-label>
                  <ion-note slot="end">{{ formatTimestamp(log.timestamp) }}</ion-note>
                </ion-item>
                <ion-item *ngIf="staffAuditLogs.length === 0">
                  <ion-label>
                    <p>No audit logs found for the selected timeframe.</p>
                  </ion-label>
                </ion-item>
              </ion-list>
            </div>
          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>
  </ion-grid>
</ion-content>