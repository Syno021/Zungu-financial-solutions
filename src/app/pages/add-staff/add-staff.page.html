<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/dashboard"></ion-back-button>
    </ion-buttons>
    <ion-title>Add Staff</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <ion-segment [(ngModel)]="selectedMode" (ionChange)="segmentChanged()">
    <ion-segment-button value="single">
      <ion-label>Add Single Staff</ion-label>
    </ion-segment-button>
    <ion-segment-button value="batch">
      <ion-label>Batch Import</ion-label>
    </ion-segment-button>
  </ion-segment>

  <!-- Single Staff Form -->
  <form *ngIf="selectedMode === 'single'" [formGroup]="staffForm" (ngSubmit)="addSingleStaff()" class="ion-padding">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Staff Information</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-item>
          <ion-label position="floating">Name <ion-text color="danger">*</ion-text></ion-label>
          <ion-input formControlName="name" type="text"></ion-input>
        </ion-item>
        <ion-text color="danger" class="error" *ngIf="staffForm.get('name')?.touched && staffForm.get('name')?.errors?.['required']">
          Name is required
        </ion-text>

        <ion-item>
          <ion-label position="floating">Email <ion-text color="danger">*</ion-text></ion-label>
          <ion-input formControlName="email" type="email"></ion-input>
        </ion-item>
        <ion-text color="danger" class="error" *ngIf="staffForm.get('email')?.touched && staffForm.get('email')?.errors?.['required']">
          Email is required
        </ion-text>
        <ion-text color="danger" class="error" *ngIf="staffForm.get('email')?.touched && staffForm.get('email')?.errors?.['email']">
          Please enter a valid email
        </ion-text>

        <ion-item>
          <ion-label position="floating">Phone <ion-text color="danger">*</ion-text></ion-label>
          <ion-input formControlName="phone" type="tel"></ion-input>
        </ion-item>
        <ion-text color="danger" class="error" *ngIf="staffForm.get('phone')?.touched && staffForm.get('phone')?.errors?.['required']">
          Phone is required
        </ion-text>

        <ion-item>
          <ion-label position="floating">Role <ion-text color="danger">*</ion-text></ion-label>
          <ion-select formControlName="role" (ionChange)="roleChanged()">
            <ion-select-option value="Doctor">Doctor</ion-select-option>
            <ion-select-option value="Nurse">Nurse</ion-select-option>
            <ion-select-option value="Admin">Admin</ion-select-option>
            <ion-select-option value="Lab Technician">Lab Technician</ion-select-option>
            <ion-select-option value="Pharmacist">Pharmacist</ion-select-option>
            <ion-select-option value="Radiologist">Radiologist</ion-select-option>
            <ion-select-option value="Paramedic">Paramedic</ion-select-option>
          </ion-select>
        </ion-item>
        <ion-text color="danger" class="error" *ngIf="staffForm.get('role')?.touched && staffForm.get('role')?.errors?.['required']">
          Role is required
        </ion-text>

        <ion-item *ngIf="showSpecialization">
          <ion-label position="floating">Specialization <ion-text color="danger">*</ion-text></ion-label>
          <ion-select formControlName="specialization">
            <ion-select-option *ngFor="let spec of specializations" [value]="spec">{{ spec }}</ion-select-option>
          </ion-select>
        </ion-item>
        <ion-text color="danger" class="error" *ngIf="showSpecialization && staffForm.get('specialization')?.touched && staffForm.get('specialization')?.errors?.['required']">
          Specialization is required for doctors
        </ion-text>

        <ion-item>
          <ion-label position="floating">Registration Number</ion-label>
          <ion-input formControlName="registrationNumber" type="text"></ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="floating">Status <ion-text color="danger">*</ion-text></ion-label>
          <ion-select formControlName="status">
            <ion-select-option value="Active">Active</ion-select-option>
            <ion-select-option value="On Leave">On Leave</ion-select-option>
            <ion-select-option value="Suspended">Suspended</ion-select-option>
            <ion-select-option value="Resigned">Resigned</ion-select-option>
          </ion-select>
        </ion-item>
        <ion-text color="danger" class="error" *ngIf="staffForm.get('status')?.touched && staffForm.get('status')?.errors?.['required']">
          Status is required
        </ion-text>

        <ion-item>
          <ion-label position="floating">Profile Picture URL</ion-label>
          <ion-input formControlName="profilePictureUrl" type="url"></ion-input>
        </ion-item>
      </ion-card-content>
    </ion-card>

    <ion-card>
      <ion-card-header>
        <ion-card-title>Address</ion-card-title>
      </ion-card-header>
      <ion-card-content formGroupName="address">
        <ion-item>
          <ion-label position="floating">Street <ion-text color="danger">*</ion-text></ion-label>
          <ion-input formControlName="street" type="text"></ion-input>
        </ion-item>
        <ion-text color="danger" class="error" *ngIf="addressForm.get('street')?.touched && addressForm.get('street')?.errors?.['required']">
          Street is required
        </ion-text>

        <ion-item>
          <ion-label position="floating">City <ion-text color="danger">*</ion-text></ion-label>
          <ion-input formControlName="city" type="text"></ion-input>
        </ion-item>
        <ion-text color="danger" class="error" *ngIf="addressForm.get('city')?.touched && addressForm.get('city')?.errors?.['required']">
          City is required
        </ion-text>

        <ion-item>
          <ion-label position="floating">Province <ion-text color="danger">*</ion-text></ion-label>
          <ion-input formControlName="province" type="text"></ion-input>
        </ion-item>
        <ion-text color="danger" class="error" *ngIf="addressForm.get('province')?.touched && addressForm.get('province')?.errors?.['required']">
          Province is required
        </ion-text>

        <ion-item>
          <ion-label position="floating">Postal Code <ion-text color="danger">*</ion-text></ion-label>
          <ion-input formControlName="postalCode" type="text"></ion-input>
        </ion-item>
        <ion-text color="danger" class="error" *ngIf="addressForm.get('postalCode')?.touched && addressForm.get('postalCode')?.errors?.['required']">
          Postal code is required
        </ion-text>

        <ion-item>
          <ion-label position="floating">Country <ion-text color="danger">*</ion-text></ion-label>
          <ion-input formControlName="country" type="text"></ion-input>
        </ion-item>
        <ion-text color="danger" class="error" *ngIf="addressForm.get('country')?.touched && addressForm.get('country')?.errors?.['required']">
          Country is required
        </ion-text>
      </ion-card-content>
    </ion-card>

    <div class="ion-text-center ion-padding">
      <ion-button type="submit" [disabled]="staffForm.invalid" expand="block">
        <ion-icon name="person-add" slot="start"></ion-icon>
        Add Staff Member
      </ion-button>
    </div>
  </form>

  <!-- Batch Import Section -->
  <div *ngIf="selectedMode === 'batch'" class="ion-padding">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Excel Batch Import</ion-card-title>
        <ion-card-subtitle>Upload an Excel file with staff information</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <ion-button expand="block" (click)="downloadTemplate()">
          <ion-icon name="download" slot="start"></ion-icon>
          Download Template
        </ion-button>

        <div class="file-upload-container ion-margin-top">
          <ion-item>
            <ion-label>Choose File</ion-label>
            <input type="file" (change)="onFileSelect($event)" accept=".xlsx, .xls" class="file-input" />
          </ion-item>
          <p *ngIf="selectedFile">Selected: {{ selectedFile.name }}</p>
        </div>

        <ion-button expand="block" [disabled]="!selectedFile" (click)="importStaff()" class="ion-margin-top">
          <ion-icon name="cloud-upload" slot="start"></ion-icon>
          Import Staff
        </ion-button>
      </ion-card-content>
    </ion-card>

    <!-- Import Results -->
    <ion-card *ngIf="importResults">
      <ion-card-header>
        <ion-card-title>Import Results</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item>
            <ion-label>
              <h2>Successfully Added: {{ importResults.successful.length }}</h2>
            </ion-label>
          </ion-item>
          <ion-item>
            <ion-label>
              <h2>Failed: {{ importResults.failed.length }}</h2>
            </ion-label>
          </ion-item>
          <ion-item>
            <ion-label>
              <h2>Validation Errors: {{ importResults.validationErrors.length }}</h2>
            </ion-label>
          </ion-item>
        </ion-list>

        <div *ngIf="importResults.successful.length > 0">
          <h3>Successfully Added Staff</h3>
          <ion-list>
            <ion-item *ngFor="let item of importResults.successful">
              <ion-label>
                <h2>{{ item.staff.name }}</h2>
                <p>{{ item.staff.email }} - {{ item.staff.role }}</p>
              </ion-label>
            </ion-item>
          </ion-list>
        </div>

        <div *ngIf="importResults.failed.length > 0">
          <h3>Failed Staff</h3>
          <ion-list>
            <ion-item *ngFor="let item of importResults.failed">
              <ion-label class="ion-text-wrap">
                <h2>{{ item.staff.name }}</h2>
                <p>{{ item.staff.email }} - {{ item.staff.role }}</p>
                <p class="error-text">Error: {{ item.error }}</p>
              </ion-label>
            </ion-item>
          </ion-list>
        </div>

        <div *ngIf="importResults.validationErrors.length > 0">
          <h3>Validation Errors</h3>
          <ion-list>
            <ion-item *ngFor="let error of importResults.validationErrors">
              <ion-label class="ion-text-wrap">
                <p>Row {{ error.row }}: {{ error.message }}</p>
              </ion-label>
            </ion-item>
          </ion-list>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Loading Indicator -->
  <div *ngIf="isLoading" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>{{ loadingMessage }}</p>
  </div>
</ion-content>